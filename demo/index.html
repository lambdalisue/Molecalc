<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Molecalc</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h1>Molecule Calculation Tool</h1>
    <p>Calculate required Weight [g] or Volume [L] for creating X [L] of Y [M] solution</p>
    <h2>Form</h2>
    <p class="supplement">Set Name to identify the results</p>
    <form id="calculation">
        <table>
            <tr>
                <td><label for="name">Name</label></td>
                <td><input type="text" id="name" value="Unknown"></td>
            </tr>
            <tr>
                <td><label for="first">Final concentration</label></td>
                <td><input type="text" id="first" value="50"></td>
                <td>
                    <select id="first_unit">
                        <option value="uM">uM</option>
                        <option value="mM" selected>mM</option>
                        <option value="M">M</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="second">Mass/Molar of source substance/solution</label></td>
                <td><input type="text" id="second" value="1"></td>
                <td>
                    <select id="second_unit">
                        <option value="g/mol">g/mol</option>
                        <option value="uM">uM</option>
                        <option value="mM">mM</option>
                        <option value="M" selected>M</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><label for="third">Total volume</label></td>
                <td><input type="text" id="third" value="50"></td>
                <td>
                    <select id="third_unit">
                        <option value="uL">uL</option>
                        <option value="mL" selected>mL</option>
                        <option value="L">L</option>
                    </select>
                </td>
            </tr>
        </table>
        <p><input type="button" onclick="calculate();" value="Calculate">
           <input type="button" onclick="clearResults();" value="Clear"></p>
    </form>
    <h2>Results</h2>
    <p class="supplement">These results are stored in <code>localStorage</code></p>
    <article>
        <dl id="results"></dl>
    </article>
    <script src="vender/jquery.min.js"></script>
    <script src="vender/coffee-script.js"></script>
    <script src="src/js/calc.js"></script>
    <script type="text/coffeescript">
        if localStorage.results?
            results = JSON.parse(localStorage.results)
            for result in results
                $("#results").append result
        else
            results = new Array
        parseUnit = (unit) ->
            if unit in ['uM', 'uL']
                return Math.pow(10, -6)
            if unit in ['mM', 'mL']
                return Math.pow(10, -3)
            return 1
        parseValue = (value, unit) ->
            value = value * parseUnit(unit)
            if value is 0
                alert "Please fill the #{name} argument"
                return null
            return value
        parseFn = ->
            unit = $("#second_unit").val()
            return if unit is "g/mol" then "gram" else "volume"
        window.clearResults = ->
            $("#results").empty()
            results = new Array
            delete localStorage.results
        window.calculate = ->
            name = $('#name').val()
            first = $('#first').val()
            firstUnit = $('#first_unit').val()
            second = $('#second').val()
            secondUnit = $('#second_unit').val()
            third = $('#third').val()
            thirdUnit = $('#third_unit').val()
            f = parseValue first, firstUnit
            s = parseValue second, secondUnit
            t = parseValue third, thirdUnit
            return if null in [f, s, t]
            fn = parseFn()
            r = calc[fn](f, s, t)
            unit = if fn is "gram" then "g" else "L"
            if r < Math.pow(10, -3)
                unit = "u#{unit}"
                r = r * Math.pow(10, 6)
                r = r * 1000
                r = Math.round(r) / 1000
            else if r < Math.pow(10, 0)
                unit = "m#{unit}"
                r = r * Math.pow(10, 3)
                r = r * 1000
                r = Math.round(r) / 1000
            display = (value, unit) ->
                return "<span class='value'>#{value}</span> <span class='unit'>#{unit}</span>"
            message = """
            <dt>#{name} - #{(new Date)}</dt>
            <dd>
                <strong>#{display(r, unit)}</strong> is required to create #{display(third, thirdUnit)}
                of #{display(first, firstUnit)} solution with #{display(second, secondUnit)} substance/solution
            </dd>
            """
            $("#results").prepend(message)
            results.unshift message
            localStorage.results = JSON.stringify(results)
    </script>
    <small><a href="test.html">Confirm with Mocha test</a></small>
</body>
</html>

